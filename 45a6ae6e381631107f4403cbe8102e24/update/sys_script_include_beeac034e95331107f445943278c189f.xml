<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_snc_accessprov_0.APCommonFunctions</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Provide functions to interact with AA.</description>
        <name>APCommonFunctions</name>
        <script><![CDATA[var APCommonFunctions = Class.create();
APCommonFunctions.prototype = {
    initialize: function() {},
    type: 'APCommonFunctions',
    restSrc: 'x_snc_accessprov_0.AA Authentication',
    defaultPass: "abc@123123",
    defaultRole: '224',
    reqAccessT: new GlideRecord('x_snc_accessprov_0_aa_request_access'),
    grpMemT: new GlideRecord('sys_user_grmember'),
    event1: 'x_snc_accessprov_0.send_mail_to_user',
    event2: 'x_snc_accessprov_0.inform_admin',

    CreateOrRejectUser: function(createOrReject, user) {
        var sts = "pending";
        if (createOrReject == "create") {
            var result = this.CreateUser(user);
            if (result.isCreated)
                sts = "granted";
        }
        if (createOrReject == "reject") {
            sts = "rejected";
            this.RejectUser(user);
        }
        var details = {
            'sts': sts,
            'name': user.name,
            'pass': this.defaultPass,
            'reason': user.rejectReason || ""
        };

        gs.info("SctiptInclude: Calling UserCreationOrRejection Event...");
        gs.eventQueue(name = this.event1, record = this.reqAccessT, parm1 = user.email, parm2 = JSON.stringify(details));
        gs.info("SctiptInclude: Event Created");
        if (result)
            return result;
    },

    CreateUser: function(userInfo) {
        var logName = "SCRIPT- CreateUser: ";
        var result = {};

        try {
            // Get Access Token
            var tkn = this.GetToken();

            //Initialize the required REST Message
            var req = new sn_ws.RESTMessageV2(this.restSrc, 'Create User');
            req.setRequestHeader("x-authorization", tkn);
            req.setStringParameterNoEscape('firstName', userInfo.fname);
            req.setStringParameterNoEscape('lastName', userInfo.lname);
            req.setStringParameterNoEscape('mailId', userInfo.email);
            req.setStringParameterNoEscape('pass', this.defaultPass);
            req.setStringParameterNoEscape('userName', userInfo.uid);
            req.setStringParameterNoEscape('id', this.defaultRole);

            gs.info(logName + "User Creation | Creating User...");

            var response = req.execute();
            var responseBody = response.getBody();
            var httpStatus = response.getStatusCode();
            gs.info(logName + "User Creation | Result - HTTP status Code: " + httpStatus);
            var parsed = JSON.parse(responseBody);
            if (httpStatus == 201) {
                // User Created Successfully
                result.isCreated = true;
                gs.info(logName + "User Creation | SUCCESS | New ID is " + parsed.id);
                this.UpdateRequestTable(userInfo, parsed.id, "granted");

            } else {
                //Failed to create user through api
                result.isCreated = false;
                result.msg = parsed.message;
                gs.error(logName + "User Creation | FAILED | Reason is " + parsed.message);
            }
        } catch (e) {
            gs.error(logName + "User Creation | Exception: " + e);
            result.isCreated = false;
            result.msg = "An error occurred while creating the user.";
        }

        return result;
    },

    FetchUsersOfGroup: function(sysId) {
        this.grpMemT.addQuery('group', sysId);
        this.grpMemT.query();
        var users = [];
        while (this.grpMemT.next()) {
            users.push(this.grpMemT.user.email.toString());
        }
        return users;
    },

    GetToken: function() {
        var r = new sn_ws.RESTMessageV2(this.restSrc, 'Default Post');
        r.setStringParameterNoEscape('api_key', 'ii5_V`~@t<3oE|0h1XIQqIUc{|yWotEoK3Oryz^n');
        r.setStringParameterNoEscape('username', 'X253816');
        var response = r.execute();
        var responseBody = response.getBody();
        var httpStatus = response.getStatusCode();

        if (httpStatus == 200) {
            // Get the Access Token
            return JSON.parse(responseBody).token;
        }
    },

    GetUserByID: function(id) {
        if (id) {
            gs.info("Checking info for Id: " + id);
            var token = this.GetToken();
            var req = new sn_ws.RESTMessageV2(this.restSrc, 'Get User by ID');
            req.setRequestHeader("x-authorization", token);
            req.setStringParameterNoEscape('uid', id);
            var response = req.execute();
            var responseBody = response.getBody();
            var httpStatus = response.getStatusCode();
            gs.info("Script - Response Status: " + httpStatus);

            if (httpStatus == 401)
                return this.GetUserByID(id);

            if (httpStatus == 200)
                return JSON.parse(responseBody);
        }
    },

    InformAdminOnRequest: function(userInfo) {
        var adminMailList = this.FetchUsersOfGroup('333afe4c1c1731107f44d85edddcec9e');
        gs.info("Admin List: " + adminMailList);
        gs.info("SctiptInclude: Calling Inform Admin Event...");

        var details = {
            "userInfo": userInfo,
            'adminMailList': adminMailList
        };

        gs.eventQueue(name = this.event2, record = this.grpMemT, parm1 = "yashwanthgowda.hr@external.merckgroup.com", parm2 = JSON.stringify(details));
        gs.info("SctiptInclude: Event Created");
    },

    NotifyUserCreation: function(sts, name, to, reason, isNew) {
        var sub, body, content, header = 'Hi ' + name + ',\n\n',
            footer = '\n\nThanks & Regards,\nServiceNow';
        sub = 'AutomationAnywhere Access Request Notification | ';
        if (isNew) {
            sub += 'Requested';
            content = 'Your request has been placed. Please wait for the admin approval.';
        } else {
            if (sts == 0) {
                sub += 'Approved';
                content = 'Your request has been approved by Admin.\nDefault Password is ' + this.pass;
            } else {
                sub += 'Rejected';
                if (reason)
                    content = 'Your request has been rejected by Admin. Reason: ' + reason;
                else
                    content = 'Your request has been rejected by Admin.';
            }
        }
        body = header + content + footer;

        // Create a GlideEmailOutbound object
        var email = new GlideEmailOutbound();
        //mail.addRecipient(to);
        email.addAddress('cc', to);
        email.setSubject(sub);
        email.setBody(body);

        // Save and send the email
        var emailSysId = email.save();

        // Optionally, you can check for errors
        if (email.error()) {
            gs.error('Email sending failed: ' + email.errorMsg());
        } else {
            gs.info('Email sent successfully.');
        }

    },

    RejectUser: function(userInfo) {
        gs.info("Rejecting request");
        this.reqAccessT.addQuery('sys_id', userInfo.sysId);
        this.reqAccessT.query();
        if (this.reqAccessT.next()) {
            this.reqAccessT.setValue('status', 'rejected');
            this.reqAccessT.update('updated status of record: ' + userInfo.sysId + ' to REJECTED');
        }
    },

    UpdateRequestTable: function(userInfo, newId, status) {
        this.reqAccessT.addQuery('sys_id', userInfo.sysId);
        this.reqAccessT.query();
        if (this.reqAccessT.next()) {
            this.reqAccessT.setValue('id', newId);
            this.reqAccessT.setValue('status', status);
            this.reqAccessT.update('updated ID of record: ' + userInfo.sysId);
        }
    },

};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-12-21 06:28:28</sys_created_on>
        <sys_id>beeac034e95331107f445943278c189f</sys_id>
        <sys_name>APCommonFunctions</sys_name>
        <sys_package display_value="AccessProvider" source="x_snc_accessprov_0">45a6ae6e381631107f4403cbe8102e24</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="AccessProvider">45a6ae6e381631107f4403cbe8102e24</sys_scope>
        <sys_update_name>sys_script_include_beeac034e95331107f445943278c189f</sys_update_name>
    </sys_script_include>
</record_update>
