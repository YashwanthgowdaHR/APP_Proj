<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function(spUtil,spModal) {
  /* widget controller */
  var c = this;
	
	// delete object property if exists
	function deleteProp(obj, key) {
		if(obj.hasOwnProperty(key)) { 
			delete obj[key];
		}
		return obj;
	}
	
	// Reset data properties
	function resetData() {
		deleteProp("action");
		deleteProp("userId");
		deleteProp("sysId");
	}
	
	function handleSuccess(res) {
		resetData();
		c.server.refresh();
	}

	function handleError(error) {
		// Handle or log the error as needed
		console.error('An error occurred:', error);
		resetData();
	}
	c.delete = function(userId, sysId){
		console.log(sysId);
		var warn = '<i class="fa fa-warning" aria-hidden="true"></i>';
		spModal.confirm("Are you sure to <b>remove</b> this user?").then(function(confirmed) {
			spUtil.addTrivialMessage("Removing user...");
			c.data.userId = userId;
		c.data.sysId = sysId;
		c.data.action = "removeUser";
		c.server.update().then(handleSuccess).catch(handleError);
		})
		
	}
	
	
};]]></client_script>
        <controller_as>c</controller_as>
        <css>th, td{
  text-align: center;
  vertical-align: middle !important;
}

</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>tsp_admin_usrs_list</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Admin - Users List</name>
        <option_schema/>
        <public>false</public>
        <roles>x_snc_accessprov_0.admin</roles>
        <script><![CDATA[(function () {
	data.userInfo = [];
	var table = new GlideRecord('x_snc_accessprov_0_aa_request_access');
	var apcf = new APCommonFunctions();
	var i = 1;
	table.addQuery('status', 'granted');
	table.query();

	while (table.next()) {
		var userDetails = apcf.getUserByID(table.getValue("id"))

		var roleDetails = "";
		if (userDetails) {
			for (var index in userDetails.roles) {
				var role = userDetails.roles[index];
				roleDetails += role.name + ";";
			}

			//gs.info("Roles: "+roleDetails)
			data.userInfo.push({
				no: i++,
				name: table.getValue('first_name').toString() + " " + table.getValue('last_name').toString(),
				mailId: table.getValue('email_id').toString(),
				uid: table.getValue('x_m_uid').toString(),
				automationName: table.getValue('automation_name').toString(),
				environment: table.getDisplayValue('environment').toString(),
				status: table.getDisplayValue('status').toString(),
				id: table.getValue("id"),
				role: roleDetails,
				sysId: table.getValue("sys_id")
			});
		}
	}

	if (input) {
		if (input.action == "removeUser") {
			try {
				var userId = input.userId;
				var sysId = input.sysId;
				apcf.deleteUsr(userId);
				table = new GlideRecord('x_snc_accessprov_0_aa_request_access');
				table.addQuery('sys_id',sysId);
				table.query();
				while(table.next()){
					gs.info("Updating status of User as Removed");
					table.setValue('status', 'removed');
					table.update("User has been deleted");
				}
				gs.addInfoMessage("User has been removed");
			} catch (e) {
				gs.error('Error deleting user:', e);
				gs.addErrorMessage('An error occurred while rejecting the request.');
			}

		}
	}
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-12-05 10:45:46</sys_created_on>
        <sys_id>6f57e223343631107f44f748c83411d2</sys_id>
        <sys_name>Admin - Users List</sys_name>
        <sys_package display_value="AccessProvider" source="x_snc_accessprov_0">45a6ae6e381631107f4403cbe8102e24</sys_package>
        <sys_policy/>
        <sys_scope display_value="AccessProvider">45a6ae6e381631107f4403cbe8102e24</sys_scope>
        <sys_update_name>sp_widget_6f57e223343631107f44f748c83411d2</sys_update_name>
        <template><![CDATA[<div class="table-responsive-sm" ng-if="data.userInfo.length > 0">
  <h2>User Details</h2>
  <table class="table table-hover table-bordered">
    <thead>
      <tr>
        <th scope="col">#</th>
        <th scope="col">Name</th>
        <th scope="col">MUID / XUID</th>
        <th scope="col">Mail Id</th>
        <th scope="col">Roles</th>
        <!-- <th scope="col">Automation Name</th> -->
        <th scope="col">Environment</th>
        <th scope="col">Status</th>
        <th scope="col">Action</th>
      </tr>
    </thead>
    <tbody>
      <tr ng-repeat="info in data.userInfo">
        <td scope="row">{{info.no}}</td>
        <td>{{info.name}}</td>
        <td>{{info.uid}}</td>
        <td>{{info.mailId}}</td>
        <td>{{info.role}}</td>
        <!-- <td>{{info.automationName}}</td> -->
        <td>{{info.environment}}</td>
        <td>{{info.status}}</td>
        <td><button ng-click="c.delete(info.id, info.sysId)" class="btn btn-danger btn-md"> <i class="fa fa-close fa-md"></i></button></td>
      </tr>
    </tbody>
  </table>
</div>
<div ng-if="data.userInfo.length <= 0">
  <h2>
    No records found.
  </h2>
</div>
]]></template>
    </sp_widget>
</record_update>
